# =============================================================================
# Traefik Dynamic Configuration - Middlewares
# =============================================================================
# This file is automatically loaded by Traefik from the config/ directory
# Reference: https://doc.traefik.io/traefik/middlewares/overview/

http:
  middlewares:
    # =========================================================================
    # Security Headers Middleware
    # =========================================================================
    security-headers:
      headers:
        # Force HTTPS
        sslRedirect: true
        stsSeconds: 31536000
        stsIncludeSubdomains: true
        stsPreload: true
        
        # Prevent clickjacking
        frameDeny: true
        
        # Prevent MIME sniffing
        contentTypeNosniff: true
        
        # XSS Protection
        browserXssFilter: true
        
        # Referrer Policy
        referrerPolicy: "strict-origin-when-cross-origin"
        
        # Permissions Policy
        permissionsPolicy: "camera=(), microphone=(), geolocation=()"
        
        # Content Security Policy (customize for your needs)
        contentSecurityPolicy: "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'"
        
        # Remove server headers
        customResponseHeaders:
          X-Powered-By: ""
          Server: ""
    
    # =========================================================================
    # Compression Middleware
    # =========================================================================
    gzip-compression:
      compress:
        minResponseBodyBytes: 1024
    
    # =========================================================================
    # Rate Limiting Middlewares
    # =========================================================================
    # Moderate rate limiting (100 req/s)
    rate-limit-moderate:
      rateLimit:
        average: 100
        burst: 50
        period: 1s
    
    # Strict rate limiting (10 req/s)
    rate-limit-strict:
      rateLimit:
        average: 10
        burst: 5
        period: 1s
    
    # API rate limiting (1000 req/min)
    rate-limit-api:
      rateLimit:
        average: 1000
        burst: 200
        period: 1m
    
    # =========================================================================
    # Circuit Breaker Middleware
    # =========================================================================
    circuit-breaker:
      circuitBreaker:
        expression: "NetworkErrorRatio() > 0.5 || ResponseCodeRatio(500, 600, 0, 600) > 0.3"
    
    # =========================================================================
    # Retry Middleware
    # =========================================================================
    retry-policy:
      retry:
        attempts: 3
        initialInterval: 100ms
    
    # =========================================================================
    # CORS Middleware (customize domains)
    # =========================================================================
    cors-allow-all:
      headers:
        accessControlAllowOriginList:
          - "*"
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        accessControlAllowHeaders:
          - "*"
        accessControlMaxAge: 3600
    
    # Restricted CORS (example - customize domains)
    cors-restricted:
      headers:
        accessControlAllowOriginList:
          - "https://yourdomain.com"
          - "https://www.yourdomain.com"
        accessControlAllowMethods:
          - GET
          - POST
          - OPTIONS
        accessControlAllowHeaders:
          - "Content-Type"
          - "Authorization"
        accessControlMaxAge: 3600
    
    # =========================================================================
    # IP Whitelist Examples
    # =========================================================================
    # Local network only
    ip-whitelist-local:
      ipWhiteList:
        sourceRange:
          - "127.0.0.1/32"
          - "192.168.0.0/16"
          - "172.16.0.0/12"
          - "10.0.0.0/8"
    
    # Example: Office IP whitelist (customize)
    ip-whitelist-office:
      ipWhiteList:
        sourceRange:
          - "1.2.3.4/32"  # Replace with your office IP
    
    # =========================================================================
    # Redirect Schemes
    # =========================================================================
    redirect-to-https:
      redirectScheme:
        scheme: https
        permanent: true
    
    # Redirect www to non-www
    redirect-www-to-non-www:
      redirectRegex:
        regex: "^https://www\\.(.+)"
        replacement: "https://$1"
        permanent: true
    
    # Redirect non-www to www
    redirect-non-www-to-www:
      redirectRegex:
        regex: "^https://(?!www\\.)(.+)"
        replacement: "https://www.$1"
        permanent: true
    
    # =========================================================================
    # Request/Response Modification
    # =========================================================================
    # Strip prefix from path
    strip-api-prefix:
      stripPrefix:
        prefixes:
          - "/api/v1"
          - "/api/v2"
    
    # Add prefix to path
    add-api-prefix:
      addPrefix:
        prefix: "/api"
    
    # Custom headers for API responses
    api-headers:
      headers:
        customResponseHeaders:
          X-API-Version: "1.0"
          X-Custom-Header: "value"
    
    # =========================================================================
    # Buffering
    # =========================================================================
    # Useful for large file uploads
    buffering:
      buffering:
        maxRequestBodyBytes: 10485760  # 10MB
        maxResponseBodyBytes: 10485760  # 10MB
        memRequestBodyBytes: 2097152    # 2MB
        memResponseBodyBytes: 2097152    # 2MB
    
    # =========================================================================
    # Error Pages (customize)
    # =========================================================================
    custom-errors:
      errors:
        status:
          - "400-599"
        service: error-pages
        query: "/{status}.html"
