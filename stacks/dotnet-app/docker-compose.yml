# =============================================================================
# FILE: docker-compose.yml
# DESCRIPTION: Docker Compose configuration for .NET applications stack
# VERSION: 1.0 - Environment variables migration
# =============================================================================

services:
  # PostgreSQL database service (default)
  postgres:
    image: postgres:${POSTGRES_VERSION:-16}
    container_name: ${STACK_NAME:-dotnet}-postgres
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5

  # SQL Server database service (optional)
  sqlserver:
    image: mcr.microsoft.com/mssql/server:${SQLSERVER_VERSION:-2022-latest}
    container_name: ${STACK_NAME:-dotnet}-sqlserver
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      ACCEPT_EULA: "Y"
      SA_PASSWORD: ${SQLSERVER_SA_PASSWORD}
      MSSQL_PID: ${SQLSERVER_EDITION:-Developer}
    volumes:
      - sqlserver-data:/var/opt/mssql
    networks:
      - internal
    healthcheck:
      test: ["CMD", "/opt/mssql-tools/bin/sqlcmd", "-S", "localhost", "-U", "sa", "-P", "$$SQLSERVER_SA_PASSWORD", "-Q", "SELECT 1"]
      interval: 30s
      timeout: 10s
      retries: 5
    profiles:
      - sqlserver

  # MySQL database service (optional)
  mysql:
    image: mysql:${MYSQL_VERSION:-8.4}
    container_name: ${STACK_NAME:-dotnet}-mysql
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - internal
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost --silent || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    profiles:
      - mysql

  # Main .NET application service
  app:
    # Use pre-built image from registry OR build from source
    image: ${DOTNET_IMAGE}
    # Optional: Uncomment to build from source
    # build:
    #   context: ${BUILD_CONTEXT:-./app}
    #   dockerfile: ${DOCKERFILE:-Dockerfile}
    container_name: ${STACK_NAME:-dotnet}-app
    restart: ${RESTART_POLICY:-unless-stopped}
    environment:
      # ASP.NET Core configuration
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Production}
      - ASPNETCORE_URLS=http://+:${APP_PORT:-8080}
      
      # Database connection (hierarchical format for .NET)
      - ConnectionStrings__DefaultConnection=${DB_CONNECTION_STRING}
      
      # JWT Configuration (if using authentication)
      - JwtSettings__SecretKey=${JWT_SECRET}
      - JwtSettings__Issuer=${JWT_ISSUER}
      - JwtSettings__Audience=${JWT_AUDIENCE}
      - JwtSettings__ExpiryMinutes=${JWT_EXPIRY_MINUTES:-60}
      
      # Application settings
      - AppSettings__Domain=${DOMAIN}
      - AppSettings__ApiKey=${API_KEY:-}
      
      # CORS settings (if needed)
      - CORS__AllowedOrigins=${CORS_ALLOWED_ORIGINS:-*}
      
      # Email settings (if needed)
      - EmailSettings__SmtpHost=${SMTP_HOST:-}
      - EmailSettings__SmtpPort=${SMTP_PORT:-587}
      - EmailSettings__SmtpUser=${SMTP_USER:-}
      - EmailSettings__SmtpPassword=${SMTP_PASSWORD:-}
      - EmailSettings__FromAddress=${SMTP_FROM:-}
      
      # Logging
      - Logging__LogLevel__Default=${LOG_LEVEL:-Information}
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - internal
      - traefik-net
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.${STACK_NAME:-dotnet-app}.rule=Host(`${DOMAIN}`)"
      - "traefik.http.routers.${STACK_NAME:-dotnet-app}.entrypoints=websecure"
      - "traefik.http.routers.${STACK_NAME:-dotnet-app}.tls=true"
      - "traefik.http.routers.${STACK_NAME:-dotnet-app}.tls.certresolver=le"
      - "traefik.http.services.${STACK_NAME:-dotnet-app}.loadbalancer.server.port=${APP_PORT:-8080}"
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:${APP_PORT:-8080}${HEALTH_CHECK_PATH:-/health} || exit 1"]
      interval: ${HEALTH_CHECK_INTERVAL:-30s}
      timeout: ${HEALTH_CHECK_TIMEOUT:-10s}
      retries: ${HEALTH_CHECK_RETRIES:-5}
      start_period: ${HEALTH_CHECK_START_PERIOD:-60s}
    deploy:
      resources:
        limits:
          memory: ${MEMORY_LIMIT:-1G}
          cpus: ${CPU_LIMIT:-0.5}

  # Migration tool service (optional)
  migrate:
    image: ${DOTNET_IMAGE}
    container_name: ${STACK_NAME:-dotnet}-migrate
    profiles: 
      - tools
    environment:
      - ConnectionStrings__DefaultConnection=${DB_CONNECTION_STRING}
      - ASPNETCORE_ENVIRONMENT=${ASPNETCORE_ENVIRONMENT:-Production}
    command: ["dotnet", "ef", "database", "update"]
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - internal

volumes:
  postgres-data:
    name: ${STACK_NAME:-dotnet}_postgres_data
  sqlserver-data:
    name: ${STACK_NAME:-dotnet}_sqlserver_data
  mysql-data:
    name: ${STACK_NAME:-dotnet}_mysql_data

networks:
  internal:
    driver: bridge
    name: ${STACK_NAME:-dotnet}_internal
  traefik-net:
    external: true
    name: ${TRAEFIK_NETWORK:-traefik-net}
